<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="AI之覔">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>【08】find_package 详解 - personal-知识库</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../../extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/diff.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/llvm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/nasm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/txt.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">personal-知识库</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">首页</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">技术博文</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">开发工具</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">cmake</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../01-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/" class="dropdown-item">【01】安装与基本介绍</a>
</li>
            
<li>
    <a href="../02-CMake%20%E7%9A%84%E6%96%87%E4%BB%B6%E5%88%86%E5%B8%83/" class="dropdown-item">【02】CMake 的文件分布</a>
</li>
            
<li>
    <a href="../03-%E5%8F%98%E9%87%8F%E7%9A%84%E8%AE%BE%E7%BD%AE%E4%B8%8E%E5%BC%95%E7%94%A8/" class="dropdown-item">【03】变量的设置与引用</a>
</li>
            
<li>
    <a href="../04-%E8%BF%90%E7%AE%97%E7%AC%A6%E4%B8%8E%E6%9D%A1%E4%BB%B6%E3%80%81%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5/" class="dropdown-item">【04】运算符与条件、循环语句</a>
</li>
            
<li>
    <a href="../05-%E7%9B%AE%E6%A0%87%E6%9E%84%E5%BB%BA/" class="dropdown-item">【05】目标构建</a>
</li>
            
<li>
    <a href="../06-%E5%8F%98%E9%87%8F%E5%8F%82%E4%B8%8E%20C%2B%2B%20%E7%9A%84%E7%BC%96%E8%AF%91/" class="dropdown-item">【06】变量参与 C++ 的编译</a>
</li>
            
<li>
    <a href="../07-%E5%AE%8F%E4%B8%8E%E5%87%BD%E6%95%B0/" class="dropdown-item">【07】宏与函数</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">【08】find_package 详解</a>
</li>
            
<li>
    <a href="../09-%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="dropdown-item">【09】生成器表达式</a>
</li>
            
<li>
    <a href="../10-%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%AF%BC%E5%87%BA%E4%B8%8E%E5%AE%89%E8%A3%85/" class="dropdown-item">【10】项目的导出与安装</a>
</li>
            
<li>
    <a href="../11-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="dropdown-item">【11】项目实战</a>
</li>
            
<li>
    <a href="../12-CTest%20%E5%B7%A5%E5%85%B7/" class="dropdown-item">【12】CTest 工具</a>
</li>
            
<li>
    <a href="../13-CPack%20%E5%B7%A5%E5%85%B7/" class="dropdown-item">【13】CPack 工具</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/serendipitywgy/personal-docs" class="nav-link">GitHub</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../07-%E5%AE%8F%E4%B8%8E%E5%87%BD%E6%95%B0/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../09-%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/serendipitywgy/personal-docs/edit/master/docs/开发工具/cmake/08-find_package 详解.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#08find_package" class="nav-link">【08】find_package 详解</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#1" class="nav-link">1. 前言</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2-find_package" class="nav-link">2. find_package 解析过程</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#3-module" class="nav-link">3. Module 模式</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#4-config" class="nav-link">4. Config 模式</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#5-findxxxcmake" class="nav-link">5. FindXXX.cmake 简单写法</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#6-xxxconfigcmake" class="nav-link">6. XXXConfig.cmake</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="08find_package">【08】find_package 详解</h1>
<h2 id="1">1. 前言</h2>
<p>先看以下寻找并包含 OpenCV 的 <code>CMakeLists.txt</code> 示例</p>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.10)

project(Demo)

find_package(OpenCV REQUIRED)

add_executable(demo main.cpp)

target_link_libraries(
  demo
  PRIVATE ${OpenCV_LIBS}
)
</code></pre>
<p>这是一段再熟悉不过的 CMakeLists.txt 代码，我们通过 <code>find_package</code> 命令寻找到了OpenCV库，并获得了其中的导入目标列表。我们可以使用 <code>message</code> 验证一下 <code>OpenCV_LIBS</code> 包含的内容</p>
<pre><code class="language-cmake">foreach(m ${OpenCV_LIBS})
  message(STATUS ${m})
endforeach()

# 输出结果
# opencv_core;opencv_imgproc;opencv_highgui;opencv_imgcodecs; ...
</code></pre>
<p>那么CMake是如何通过 <code>find_package</code> 命令找到OpenCV并且完成配置的呢?</p>
<h2 id="2-find_package">2. find_package 解析过程</h2>
<p><strong>Module 模式</strong></p>
<p>这种模式下，<code>find_package</code> 需要解析 <code>Findxxx.cmake</code> 文件，这也是 <code>find_package</code> 默认工作的模式</p>
<p><strong>Config 模式</strong></p>
<p>这种模式下，<code>find_package</code> 需要解析 <code>xxxConfig.cmake</code> 文件或者 <code>xxx-config.cmake</code> 文件。实际上只有 <code>Findxxx.cmake</code> 文件无法找到，即 Module 模式执行不成功，才会进入 Config 模式。</p>
<h2 id="3-module">3. Module 模式</h2>
<h3 id="31">3.1 用法</h3>
<p><strong>Module</strong> 模式下 <code>find_package</code> 的参数为：</p>
<pre><code class="language-cmake">find_package(&lt;package&gt; [VERSION] [EXACT] [QUIET] [MODULE]
             [REQUIRED] [[COMPONENTS] [components...]]
             [OPTIONAL_COMPONENTS components...]
             [NO_POLICY_SCOPE])
</code></pre>
<p>这里对上述提及到的参数做个简单的解释：</p>
<table>
<thead>
<tr>
<th align="center">参数名称</th>
<th align="center">可选性</th>
<th>名称</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>package</code></td>
<td align="center">必填</td>
<td>需要查找的包名</td>
<td align="left">注意大小写</td>
</tr>
<tr>
<td align="center"><code>VERSION</code></td>
<td align="center">可选</td>
<td>指定版本，如果指定就必须检查找到的<br>包的版本是否和<code>VERSION</code>兼容</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"><code>EXACT</code></td>
<td align="center">可选</td>
<td>如果指定该参数，则表示需要寻找必须<br>完全匹配的版本而不是兼容版本</td>
<td align="left">配合<code>VERSION</code>使用</td>
</tr>
<tr>
<td align="center"><code>REQUIRED</code></td>
<td align="center">可选</td>
<td>表示一定要找到包，找不到的话就立即<br>停掉整个 CMake 解析过程</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"><code>QUIET</code></td>
<td align="center">可选</td>
<td>表示如果查找失败，不会在屏幕进行输出</td>
<td align="left">不得与<code>REQUIRED</code>搭配</td>
</tr>
<tr>
<td align="center"><code>MODULE</code></td>
<td align="center">可选</td>
<td>前面提到说 “ <strong>Module</strong> 模式执行失败，<br>才会进入 <strong>Config</strong> 模式”，但是假如加入了<br><code>MODULE</code>选项，那么就只在 <strong>Module</strong> 模式<br>查找，如果 <strong>Module</strong> 模式下查找失败并不<br>切换到 <strong>Config</strong> 模式查找。</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"><code>COMPONENTS</code></td>
<td align="center">可选</td>
<td>表示查找的包中必须要找到的组件<br>(components)，如果有任何一个找不到<br>就算失败，类似于<code>REQUIRED</code>，导致<br>CMake 停止执行。</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h3 id="32">3.2 文件搜索过程</h3>
<ul>
<li><a href="#_2-find-package-解析过程">#2</a> 提到过，Module 模式下需要查找到名为 <code>Find&lt;PackageName&gt;.cmake</code> 的配置文件。该文件的查找过程只涉及到两个路径：<code>CMAKE_MODULE_PATH</code> 和 CMake 安装路径下的 Modules 目录。即，搜索路径依次为：</li>
<li>先在 <code>CMAKE_MODULE_PATH</code> 变量对应的路径中查找。如果路径为空，或者路径中查找失败，则在 CMake 安装目录（即 <code>CMAKE_ROOT</code> 变量）下的 Modules 目录中查找。这个目录通常为 <code>/usr/share/cmake-x.xx/Modules</code>。这两个变量可以在<code>CMakeLists.txt</code>文件中打印查看具体内容：</li>
<li>其中 <code>CMAKE_MODULE_PATH</code> 默认为空，可以利用 <code>set</code> 命令对该变量进行设置。</li>
<li>在安装 CMake 时，CMake 为我们提供了很多开发库的 <code>FindXXX.cmake</code> 模块文件，这些文件都定义在 <code>CMAKE_ROOT</code> 指代路径的文件夹里面。可以在终端通过键入以下命令进行查询</li>
</ul>
<h2 id="4-config">4. Config 模式</h2>
<h3 id="41">4.1 用法</h3>
<p><strong>Config</strong> 模式下 <code>find_package</code> 的完整命令参数如下，不必全部了解。</p>
<ul>
<li>相比于 <strong>Module</strong> 模式，<strong>Config</strong> 模式的参数更多，也更复杂，但实际在使用过程中我们并不会用到所有参数，大部分参数都是可选的，我们只需要掌握基本的参数用法即可。</li>
<li>其中具体查找库并给 <code>XXX_INCLUDE_DIRS</code> 和 <code>XXX_LIBS</code> 两个变量赋值的操作由 <code>XXXConfig.cmake</code> 模块完成。</li>
<li>两种模式看起来似乎差不多，不过 CMake 默认采取 <strong>Module</strong> 模式，如果 <strong>Module</strong> 模式未找到库，才会采取 <strong>Config</strong> 模式。总之，<strong>Config</strong> 模式是一个备选策略。通常，库安装时会拷贝一份 <code>XXXConfig.cmake</code> 到系统目录中，因此在没有显式指定搜索路径时也可以顺利找到。</li>
</ul>
<h3 id="42">4.2 文件搜索过程</h3>
<ul>
<li>
<p>与 <strong>Module</strong> 模式不同，<strong>Config</strong> 模式需要查找的路径非常非常非常多，也要匹配很多的可能性，因此有些路径是首先作为根目录，然后进行子目录的匹配，而有些则是直接指定到具体的 <code>XXXConfig.cmake</code> 文件。具体将会按照如下顺序进行查找：</p>
</li>
<li>
<p><code>&lt;PackageName&gt;_DIR</code></p>
</li>
<li><code>CMAKE_PREFIX_PATH</code>、<code>CMAKE_FRAMEWORK_PATH</code>、<code>CMAKE_APPBUNDLE_PATH</code></li>
<li><code>PATH</code>环境变量路径</li>
<li><code>CMAKE_SYSTEM_PREFIX_PATH</code>等系统变量路径</li>
</ul>
<p><strong>\&lt;PackageName>_DIR</strong></p>
<p>首先搜索名为<code>&lt;PackageName&gt;_DIR</code>的 CMake 变量或环境变量路径，这个变量默认为空。这个路径需要直接指定到<code>&lt;PackageName&gt;Config.cmake</code>或<code>&lt;lower-case-package-name&gt;-config.cmake</code>文件所在目录才能找到，可参考以下示例：</p>
<p><strong>CMAKE_PREFIX_PATH 等变量</strong></p>
<p>如果按照<code>&lt;PackageName&gt;_DIR</code>搜索不到相应的<code>XXXConfig.cmake</code>文件的话，则会查找名为<code>CMAKE_PREFIX_PATH</code>、<code>CMAKE_FRAMEWORK_PATH</code>、<code>CMAKE_APPBUNDLE_PATH</code>的 CMake 变量或环境变量路径。这些变量指定的路径将作为查找时的根目录，<strong>它们默认都为空</strong>。根目录的相关内容在后文会提及。</p>
<p>::: tip
如果你电脑中安装了 <strong>ROS</strong> 并配置好之后，你在终端执行 <code>echo $CMAKE_PREFIX_PATH</code> 会发现 <strong>ROS</strong> 会将 <code>CMAKE_PREFIX_PATH</code> 这个变量设置为 <strong>ROS</strong> 中的库的路径，意思是会首先查找 <strong>ROS</strong> 安装的库，如果恰好你在 <strong>ROS</strong> 中安装了 <strong>OpenCV </strong>库，就会发现首先找到的是 <strong>ROS</strong> 中的 <strong>OpenCV</strong>，而不是你自己安装到系统中的 <strong>OpenCV</strong>。
:::</p>
<p><strong>PATH 环境变量路径</strong></p>
<ul>
<li>若还找不到，则是搜索 <code>PATH</code> 环境变量路径，这个路径也是根目录，默认为系统环境 <code>PATH</code> 环境变量值。</li>
<li>其实这个路径才是 <strong>Config</strong> 模式大部分情况下能够查找到安装到系统中各种库的原因。这个路径的查找规则为：遍历 <code>PATH</code> 环境变量中的各路径，如果该路径如果以 <code>bin</code> 或 <code>sbin</code> 结尾，则自动回退到上一级目录得到根目录。在终端键入以下内容以查看系统环境变量路径：</li>
</ul>
<p><code>bash
  echo $PATH</code></p>
<p>一般情况输出结果如下，这里对每个路径都做了换行处理，并且加了些简单的注释。</p>
<p><code>bash
  /home/&lt;user-name&gt;/.local/bin: # 回退到 /home/&lt;user-name&gt;/.local 后再进行搜索
  /usr/local/sbin:              # 回退到 /usr/local 后再进行搜索
  /usr/local/bin:               # 同上
  /usr/sbin:                    # 回退到 /usr 后再进行搜索
  /usr/bin:                     # 同上
  /sbin:                        # 回退到 / 后再进行搜索
  /bin:                         # 同上
  /usr/games:
  /usr/local/games:
  /snap/bin                     # 回退到 /snap 后再进行搜索</code></p>
<p>说明这些路径会被默认添加在 <strong>Config</strong> 模式的搜索路径中。</p>
<p><strong>CMAKE_SYSTEM_PREFIX_PATH 等变量</strong></p>
<ul>
<li>我们在安装 OpenCV 的时候，可以在 <code>cmake-gui</code> 中修改 <code>CMAKE_INSTALL_PREFIX</code> 变量的内容，把 OpenCV 安装在 <code>/opt/opencv</code> 下，我们在使用 <code>find_package</code> 时也不需要指名路径，说明除了上面的一些变量之外，还存在另外一系列路径。这里列出最重要的一个变量：<code>CMAKE_SYSTEM_PREFIX_PATH</code></li>
<li>我们可以在一个 CMakeLists.txt 文件下，输入以下内容：</li>
</ul>
<p><code>cmake
  foreach(path ${CMAKE_SYSTEM_PREFIX_PATH})
    message(STATUS "${path}")
  endforeach()</code></p>
<p>会打印出以下内容</p>
<p><code>txt
  -- /usr/local
  -- /usr
  -- /
  -- /usr/local
  -- /usr/local
  -- /usr/X11R6
  -- /usr/pkg
  -- /opt</code></p>
<ul>
<li>留意该变量最后一点包含的内容，这正是我们可以把第三方库安装在 <code>/opt</code> 的原因。事实上，很多软件包都是默认安装在 <code>/opt</code> 下的，譬如 ROS。</li>
</ul>
<p>::: tip 补充
相关包含的内容还有非常之多，有兴趣的可以阅读官网和源码，这里给出官网和源码 GitLab 地址：
- <code>find_package</code> 寻找包含路径的源码 GitLab：<a href="https://gitlab.kitware.com/cmake/cmake/-/blob/7a869ebaf13e241d8a2c52a1b5ab3dd4191bf2b6/Modules/Platform/UnixPaths.cmake#L50">源码 GitLab 地址</a>
- <code>find_package</code> 寻找包含路径的官网：<a href="https://cmake.org/cmake/help/latest/command/find_package.html#search-procedure">官网网址</a>
:::</p>
<h3 id="43">4.3 根目录路径详解</h3>
<p>上述提及到的根目录路径，在指明这些内容时，CMake 会首先检查这些根目录路径下是否有名为 <code>&lt;PackageName&gt;Config.cmake</code> 或 <code>&lt;lower-case-package-name&gt;-config.cmake</code> 的模块文件，如果没有，CMake 会继续检查或匹配这些根目录下的以下路径：</p>
<pre><code class="language-txt">&lt;prefix&gt;/(lib/&lt;arch&gt;|lib|share)/cmake/&lt;name&gt;*/
&lt;prefix&gt;/(lib/&lt;arch&gt;|lib|share)/&lt;name&gt;*/
&lt;prefix&gt;/(lib/&lt;arch&gt;|lib|share)/&lt;name&gt;*/(cmake|CMake)/
</code></pre>
<p>其中为 <code>arch</code> 系统架构名，如 Ubuntu 下一般为：<code>x86_64-linux-gnu</code>，整个 <code>(lib/&lt;arch&gt;|lib|share)</code> 为可选路径，例如 OpenCV 库而言会检查或匹配以下内容：</p>
<ol>
<li><code>&lt;prefix&gt;/lib/x86_64-linux-gnu/opencv4/</code></li>
<li><code>&lt;prefix&gt;/lib/cmake/opencv4/</code></li>
<li><code>&lt;prefix&gt;/share/opencv4/</code></li>
<li>……</li>
</ol>
<p>::: warning
上文提及过的 <code>&lt;PackageName&gt;_DIR</code> 路径不是根目录路径
:::</p>
<h2 id="5-findxxxcmake">5. FindXXX.cmake 简单写法</h2>
<p>我们使用 Module 模式，写一个 <code>FindXXX.cmake</code> 文件，来体验一下自己的<code>find_package</code></p>
<h3 id="51">5.1 案例</h3>
<p>假设某家相机厂商的 SDK 提供了以下内容，假设将其放在了 <code>/opt/camera</code> 文件夹下，请创建一个 <code>CameraDemo</code> 项目，并设计一个 <code>FindCamera.cmake</code> 文件供本项目中的其余目标包含，使其能够链接至本相机的 SDK。</p>
<pre><code class="language-txt">.
├── include
│   ├── CameraApi.h
│   ├── CameraDefine.h
│   └── CameraStatus.h
└── lib
    └── libMVSDK.so
</code></pre>
<h3 id="52">5.2 分析</h3>
<p>我们在<a href="../05-%E7%9B%AE%E6%A0%87%E6%9E%84%E5%BB%BA/">【05】目标构建</a>的导入目标中遇到过类似的情况，但这里的相机 SDK 并没有位于本项目中。</p>
<p>注意到相机厂商的 SDK 并无提供相应的 <code>CameraConfig.cmake</code> 或 <code>camera-config.cmake</code> 文件，因此需要自己手写 <code>FindCamera.cmake</code> 文件。</p>
<p>我们先把相机项目的部署框架给大概定义好：</p>
<pre><code class="language-txt">.
├── cmake
│   └── FindCamera.cmake
├── CMakeLists.txt
└── main.cpp
</code></pre>
<p>涉及到的两个 CMake 文件已经标红，这里简单描述一下</p>
<ul>
<li>
<p><code>FindCamera.cmake</code>：其他库直接包含、链接 SDK 提供的库肯定是不行的，需要事先找到 SDK 的路径，此文件就是为了提前让整个 CMake 工程找到此 SDK。</p>
</li>
<li>
<p>项目根目录的 <code>CMakeLists.txt</code>：框架整体配置，包括项目、编译属性、可执行程序的配置。这里 <code>main.cpp</code> 直接用到了 SDK 的内容，通过以下语句进行链接</p>
</li>
</ul>
<p><code>cmake
  target_link_libraries(
    demo
    PRIVATE camera
  )</code></p>
<h3 id="53">5.3 配置</h3>
<h4 id="531-cmakeliststxt">5.3.1 项目根目录的 CMakeLists.txt</h4>
<p>① 主要目的</p>
<ol>
<li>设置 <code>CMAKE_MODULE_PATH</code> 模块模式的工作路径</li>
<li>解析 <code>FindCamera.cmake</code>，并找到 camera 对应的库</li>
<li>创建可执行程序目标并链接</li>
</ol>
<p>② 示例代码</p>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.10)
project(CameraDemo)
# 本篇 2.2.2 节提及过，下一句是让 CMake 工程能够找到 FindCamera.cmake
list(CMAKE_MODULE_PATH APPEND &quot;${CMAKE_SOURCE_DIR}/cmake&quot;)

# 找到 SDK
find_package(Camera)

# 添加可执行文件并链接
add_executable(demo main.cpp)
target_link_libraries(
  demo
  PRIVATE camera
)
</code></pre>
<h4 id="532-findcameracmake">5.3.2 FindCamera.cmake</h4>
<p>① 主要任务</p>
<ol>
<li>提供一个 CMake 目标变量（一般是导入目标）</li>
<li>找到 SDK 的头文件</li>
<li>找到 SDK 的库文件</li>
<li>提供有无找到的状态信息</li>
</ol>
<p>② 详细注释的示例代码</p>
<pre><code class="language-cmake"># 设置 mvsdk 的路径（可自行设置）
set(mvsdk_root &quot;/opt/camera&quot;)

# 发现头文件路径，并设置 Camera_INCLUDE_DIRS
find_path(
  Camera_INCLUDE_DIR
  NAMES CameraApi.h CameraDefine.h CameraStatus.h
  PATHS &quot;${mvsdk_root}/include&quot;
  NO_DEFAULT_PATH # 默认路径下会包含 /usr/local 等内容，这句话表明不包含默认路径
)

# 发现库文件路径
find_library(
  Camera_LIB
  NAMES &quot;libMVSDK.so&quot;
  PATHS &quot;${mvsdk_root}/lib&quot;
  NO_DEFAULT_PATH # 同 find_path
)

# 设置导入目标，称为 mvsdk
if(NOT TARGET mvsdk)
  # 将目标设置为在项目中全局可见 GLOBAL
  add_library(mvsdk SHARED IMPORTED GLOBAL)
  # 为导入目标添加相关属性
  set_target_properties(mvsdk PROPERTIES
    INTERFACE_INCLUDE_DIRECTORIES &quot;${Camera_INCLUDE_DIR}&quot;
    IMPORTED_LOCATION &quot;${Camera_LIB}&quot;
  )
endif()

set(Camera_INCLUDE_DIRS ${Camera_INCLUDE_DIR})
set(Camera_LIBS mvsdk)

# 这里用到了一个 CMake 自带的函数，会根据指定内容设置 Camera_FOUND 变量
include(FindPackageHandleStandardArgs)
# 意为必需的参数是 Camera_LIBS，如果 Camera_LIBS 为空，则 Camera_FOUND
# 将被设置为 FALSE，并在使用 find_package(Camera REQUIRED) 时也会报错
find_package_handle_standard_args(
  Camera
  REQUIRED_VARS Camera_LIBS Camera_INCLUDE_DIRS
)
</code></pre>
<p>③ <a href="https://cmake.org/cmake/help/latest/module/FindPackageHandleStandardArgs.html?highlight=find_package_handle_standard_args#command:find_package_handle_standard_args">FindPackageHandleStandardArgs详解</a></p>
<h2 id="6-xxxconfigcmake">6. XXXConfig.cmake</h2>
<p>关于 <code>XXXConfig.cmake</code> 或 <code>xxx-config.cmake</code> 的写法会在后续文章中详细说明：</p>
<ul>
<li><a href="../09-%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/">【09】生成器表达式</a></li>
<li><a href="../10-%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%AF%BC%E5%87%BA%E4%B8%8E%E5%AE%89%E8%A3%85/">【10】项目的导出与安装</a></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright © AI之覔</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../extra.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
