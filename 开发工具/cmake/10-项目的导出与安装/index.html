<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="AI之覔">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>【10】项目的导出与安装 - personal-知识库</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../../extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/diff.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/llvm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/nasm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/txt.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">personal-知识库</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">首页</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">技术博文</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">开发工具</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">cmake</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../01-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/" class="dropdown-item">【01】安装与基本介绍</a>
</li>
            
<li>
    <a href="../02-CMake%20%E7%9A%84%E6%96%87%E4%BB%B6%E5%88%86%E5%B8%83/" class="dropdown-item">【02】CMake 的文件分布</a>
</li>
            
<li>
    <a href="../03-%E5%8F%98%E9%87%8F%E7%9A%84%E8%AE%BE%E7%BD%AE%E4%B8%8E%E5%BC%95%E7%94%A8/" class="dropdown-item">【03】变量的设置与引用</a>
</li>
            
<li>
    <a href="../04-%E8%BF%90%E7%AE%97%E7%AC%A6%E4%B8%8E%E6%9D%A1%E4%BB%B6%E3%80%81%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5/" class="dropdown-item">【04】运算符与条件、循环语句</a>
</li>
            
<li>
    <a href="../05-%E7%9B%AE%E6%A0%87%E6%9E%84%E5%BB%BA/" class="dropdown-item">【05】目标构建</a>
</li>
            
<li>
    <a href="../06-%E5%8F%98%E9%87%8F%E5%8F%82%E4%B8%8E%20C%2B%2B%20%E7%9A%84%E7%BC%96%E8%AF%91/" class="dropdown-item">【06】变量参与 C++ 的编译</a>
</li>
            
<li>
    <a href="../07-%E5%AE%8F%E4%B8%8E%E5%87%BD%E6%95%B0/" class="dropdown-item">【07】宏与函数</a>
</li>
            
<li>
    <a href="../08-find_package%20%E8%AF%A6%E8%A7%A3/" class="dropdown-item">【08】find_package 详解</a>
</li>
            
<li>
    <a href="../09-%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="dropdown-item">【09】生成器表达式</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">【10】项目的导出与安装</a>
</li>
            
<li>
    <a href="../11-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="dropdown-item">【11】项目实战</a>
</li>
            
<li>
    <a href="../12-CTest%20%E5%B7%A5%E5%85%B7/" class="dropdown-item">【12】CTest 工具</a>
</li>
            
<li>
    <a href="../13-CPack%20%E5%B7%A5%E5%85%B7/" class="dropdown-item">【13】CPack 工具</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/serendipitywgy/personal-docs" class="nav-link">GitHub</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../09-%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../11-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/serendipitywgy/personal-docs/edit/master/docs/开发工具/cmake/10-项目的导出与安装.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#10" class="nav-link">【10】项目的导出与安装</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#1" class="nav-link">1. 前言</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2" class="nav-link">2. 文件、目标的安装规则</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#3" class="nav-link">3. 导出目标的安装规则</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#4-xxxconfigcmake" class="nav-link">4. XxxConfig.cmake 文件的一般写法</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#5-cmake" class="nav-link">5. CMake 项目导出与安装的内容总结</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#thinking" class="nav-link">思考 :thinking:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="10">【10】项目的导出与安装</h1>
<h2 id="1">1. 前言</h2>
<p>在<a href="../08-find_package%20%E8%AF%A6%E8%A7%A3/">【08】find_package 详解</a>一文中我们了解到 <code>find_package</code> 的两种工作方式，第一种的 Module 模式需要我们为现成的第三方头文件库文件编写 <code>FindXxx.cmake</code> 从而能够使用 <code>find_package</code>，第二种的 Config 模式则是打包项目时采用的主流方式，即通过编写 <code>XxxConfig.cmake</code> 文件来使用 <code>find_package</code>。大多数开源项目，若是使用CMake提供了编译安装方式，一定会涉及到这一文件，例如 OpenCV 的 <code>cmake/templates</code> 文件夹中就有 <code>OpenCVConfig.cmake.in</code> 的模板文件，这一文件在CMake的配置阶段会生成对应的 <code>OpenCVConfig.cmake</code> 文件。</p>
<p>对于 <code>XxxConfig.cmake</code> 文件的写法会在最后进行介绍，在一开始让我们先了解一下安装的基本命令。</p>
<h2 id="2">2. 文件、目标的安装规则</h2>
<p align="right">—— <code>install</code> 命令</p>

<p>在现代 CMake 中，所有内容的安装，均来自 <code>install</code> 命令，包括文件（夹）、二进制目标、伪目标以及后文的导出目标。在 <code>CMakeLists.txt</code> 文件中添加了 <code>install</code> 命令并不会直接执行安装操作，实际上 <code>install</code> 只是给出了安装的规则，并发生在生成阶段。可以回顾<a href="../01-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/">【01】安装与基本介绍</a>的内容，CMake 的作用是生成建构档，而需要安装的具体内容将会生成在该建构档中，如 Unix Makefile。</p>
<p>我们可以执行</p>
<pre><code class="language-bash">cmake --install .
</code></pre>
<p>命令，完成实际的安装操作。</p>
<p>::: tip
此处只介绍具有基本文件结构的安装，导出目标的安装在下一节进行介绍。
:::</p>
<h3 id="21">2.1 文件安装</h3>
<p>即：<code>install(FILES)</code></p>
<p>这里先直接给出文件安装的 <code>install</code> 命令用法，下面列举一些常见的可选内容。</p>
<ul>
<li><code>DESTINATION</code>：指定要安装到的目标目录。</li>
<li><code>PERMISSIONS</code>：指定要安装文件的权限，权限参数要求是一系列 <code>OWNER_*</code>、<code>GROUP_*</code> 和 <code>WORLD_*</code> 权限值的组合，例如 <code>OWNER_WRITE OWNER_READ GROUP_READ WORLD_READ</code>。</li>
<li><code>CONFIGURATIONS</code>：指定要在哪些构建配置下安装文件。可以使用一个或多个构建配置的名称来限定。</li>
<li><code>COMPONENT</code>：指定要将文件归类到的组件名称，以便于后续进行管理和打包（见<a href="../13-CPack%20%E5%B7%A5%E5%85%B7/">【13】CPack</a>）。</li>
<li><code>RENAME</code>：指定在安装时重命名文件或目录的名称。</li>
<li><code>OPTIONAL</code>：表示如果文件不存在则不会抛出错误。</li>
</ul>
<pre><code class="language-cmake"># 定义于 &lt;path-to-opencv&gt;/include/CMakeLists.txt 中

install(FILES &quot;opencv2/opencv.hpp&quot;
    DESTINATION ${OPENCV_INCLUDE_INSTALL_PATH}/opencv2
    COMPONENT dev)
</code></pre>
<p>这句命令添加了将单一文件 <code>opencv2/opencv.hpp</code> 安装到指定目录的安装规则，默认情况下是 <code>/usr/local/include/opencv4/opencv2</code> 中，并归类到 <code>dev</code> 组件的安装规则中，在执行 <code>cmake --install .</code> 命令的时候会执行该安装操作。</p>
<p>其余可选内容如 <code>RENAME</code> 用法与上文给出的例子类似。</p>
<h3 id="22">2.2 目录（文件夹）安装</h3>
<p>即 <code>install(DIRECTORY)</code></p>
<p>使用方式与文件安装基本一致，但相比于文件安装，主要多出了 <code>PATTERN</code>、<code>EXCLUDE_PATTERN</code> 和 <code>RECURSE</code> 关键字，通过 <code>PATTERN</code> 和 <code>EXCLUDE_PATTERN</code> 参数指定要包含和排除的文件，使用 <code>RECURSE</code> 参数进行递归安装。下面给出一个简单的，OpenCV 中安装文档所在文件夹的例子。</p>
<pre><code class="language-cmake"># 定义于 &lt;path-to-opencv&gt;/doc/CMakeLists.txt 中

install(DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/doxygen/html
  DESTINATION &quot;${OPENCV_DOC_INSTALL_PATH}&quot;
  COMPONENT &quot;docs&quot; OPTIONAL
  ${compatible_MESSAGE_NEVER} # 可以不用管这句话
)
</code></pre>
<p>这句命令将当前二进制生成目录中的 <code>doxygen/html</code> 文件夹安装到 <code>${OPENCV_DOC_INSTALL_PATH}</code> 中，并归类到 <code>docs</code> 中，<code>OPTIONAL</code> 说明了即使这个目录不存在，也不会抛出安装的错误。同样，需要在终端执行 <code>cmake --install .</code> 命令以完成安装。</p>
<h3 id="23">2.3 目标安装</h3>
<p>即 <code>install(TARGETS)</code>，先给出目标安装的签名</p>
<pre><code class="language-cmake">install(TARGETS &lt;target&gt;... [EXPORT &lt;export-name&gt;]
        [RUNTIME_DEPENDENCIES &lt;arg&gt;...|RUNTIME_DEPENDENCY_SET &lt;set-name&gt;]
        [&lt;artifact-option&gt;...]
        [&lt;artifact-kind&gt; &lt;artifact-option&gt;...]...
        [INCLUDES DESTINATION [&lt;dir&gt; ...]]
        )
</code></pre>
<p>用法与文件、文件夹安装基本一致，但由于 CMake 中的目标不仅仅包含动态、静态库，也有可执行文件，也有接口库、导入库等伪目标，因此 CMake 目标安装是个广泛的概念，接口上也能适配多种目标的安装，例如以下命令</p>
<pre><code class="language-cmake">install(
  TARGETS my_target
  LIBRARY DESTINATION lib
  ARCHIVE DESTINATION lib
  RUNTIME DESTINATION bin
)
</code></pre>
<p>先来考虑二进制目标的情况</p>
<ul>
<li><code>LIBRARY</code> 指代的是 Unix 文件系统的共享库</li>
<li><code>ARCHIVE</code> 指代的是 Unix 文件系统的静态库，以及 Windows 下的静态链接库和导入库</li>
<li><code>RUNTIME</code> 指代的是可执行文件以及 Windows 下的动态链接库</li>
</ul>
<p>当 <code>my_target</code> 是普通库目标时，在 Linux 下，对应的 <code>*.so</code> 或 <code>*.a</code> 目标会被安装至 <code>&lt;prefix&gt;/lib</code> 下，同样，在 Windows 下，对应的 <code>*.dll</code> 和DLL导入库 <code>*.lib</code> 也会被安装到 <code>&lt;prefix&gt;/lib</code> 下。当 <code>my_target</code> 是可执行文件时，会被安装到 <code>&lt;prefix&gt;/bin</code> 下</p>
<h2 id="3">3. 导出目标的安装规则</h2>
<h3 id="31">3.1 何为导出目标、导出配置</h3>
<p>在<a href="../05-%E7%9B%AE%E6%A0%87%E6%9E%84%E5%BB%BA/#_2-4-导入目标构建">【05】目标构建 #2.4</a>我们介绍过 <code>IMPORTED</code> 导入目标的概念，虽然 <code>IMPORTED</code> 目标本身很有用，但我们仍然需要知道这些 <code>IMPORTED</code> 目标所指代或者包含的文件在磁盘上的位置。 <code>IMPORTED</code> 目标的真正强大之处在于，当提供目标文件的项目计划提供一个 CMake 文件来帮助导入它们时，可以设置项目以生成<font color="red">必要的信息</font>，以便其他 CMake 项目可以轻松地使用它，这一必要的信息就是所谓的导出目标。</p>
<p>在开发完一个库的时候，需要将其打包给他人使用（注意不是打包让他人源码编译，而是直接拿来用），我们需要提供一个包含这个库里面所有待导出目标信息的 <code>*.cmake</code> 文件，称为导出配置文件。该文件正是在 CMake 的生成阶段由导出目标生成的。不过，这一文件我们并不会直接使用，而是间接的通过使用 <code>XxxConfig.cmake</code> 的方式使用该导出目标对应的 <code>*.cmake</code> 导出配置文件。我们先回到最基本的，如何添加导出目标和生成导出配置文件。</p>
<h3 id="32">3.2 基本语法</h3>
<p>首先我们需要指定哪些目标需要导出，并且设置导出目标的名称，假设还是上文的 <code>my_target</code> 目标，我们在使用 <code>install</code> 命令时可以指定 <code>EXPORT</code>，即</p>
<pre><code class="language-cmake">install(
  TARGETS my_target
  EXPORT MyModules
  LIBRARY DESTINATION lib
  ARCHIVE DESTINATION lib
  RUNTIME DESTINATION bin
)
</code></pre>
<p>::: warning
<code>EXPORT</code> 必须在 <code>TARGETS</code> 之后，<code>[&lt;artifact-option&gt;...]</code> 之前，如<a href="#_2-3-目标安装">签名</a>的要求。也就是说，如果写成</p>
<pre><code class="language-cmake">install(
  EXPORT MyModules
  TARGETS my_target
)
</code></pre>
<p>或者</p>
<pre><code class="language-cmake">install(
  TARGETS my_target
  LIBRARY DESTINATION lib
  EXPORT MyModules
)
</code></pre>
<p>都是错误的写法，在 CMake 配置期间会报错。
:::</p>
<p>这里的 <code>MyModules</code> 就是导出目标名，并且该导出目标包含了关于 <code>my_target</code> 的所有信息，包括头文件路径、库文件路径等内容。如果我在此之上继续写入</p>
<pre><code class="language-cmake">install(
  TARGETS my_target_2
  EXPORT MyModules
  LIBRARY DESTINATION lib
  ARCHIVE DESTINATION lib
)
</code></pre>
<p>则此时导出目标 <code>MyModules</code> 包含了两个目标的内容，即 <code>my_target</code> 和 <code>my_target_2</code>。</p>
<p>最后需要将该导出目标转换为对应的 <code>*.cmake</code> 文件，即指定导出目标的安装策略，语法采用 <code>install(EXPORTS)</code></p>
<pre><code class="language-cmake">install(
  EXPORT MyModules
  FILE MyModules.cmake
  DESTINATION &quot;lib/cmake/${PROJECT_NAME}&quot; # 一般安装路径会设置在此处
)
</code></pre>
<p>如果不额外指定 OpenCV 的安装路径，可以在 <code>/usr/local/lib/cmake/opencv4</code> 下找到 <code>OpenCVModules.cmake</code> 以及 <code>OpenCVModules-release.cmake</code>这两个文件，这个就是 OpenCV 的导出配置文件。</p>
<h3 id="33">3.3 导出配置文件的基本内容</h3>
<p>我们就以 OpenCV 4.8.0 在执行完安装命令之后生成的导出配置文件</p>
<ol>
<li><code>OpenCVModules.cmake</code>，点击<a href="10/OpenCVModules.cmake.md">此处</a>跳转至该文件</li>
<li><code>OpenCVModules-release.cmake</code>，点击<a href="10/OpenCVModules-release.cmake.md">此处</a>跳转至该文件</li>
</ol>
<p>两个文件中的内容进行介绍，因为这类文件是由导出目标在安装后自动生成的，所以不论是什么项目，在内容上都具有相似性</p>
<p>上文中的 <code>OpenCVModules.cmake</code> 文件，具有以下几个部分</p>
<ol>
<li>防止重复包含，来自如下注释：</li>
</ol>
<div class="language-cmake line-numbers-mode" data-ext="cmake" data-title="cmake"><pre v-pre class="language-cmake" style="white-space: pre-wrap;"><code><span class="token comment"># Protect against multiple inclusion, which would fail when already imported targets are added once more.</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>

<p>使用 <code>foreach</code> 遍历所有待导入目标的名字（即已被安装的目标的名字），判断这些变量是否已经是目标，如果是说明已经重复包含。</p>
<ol>
<li>获取该项目的安装路径，并设置为一个变量 <code>_IMPORT_PREFIX</code>，该变量我们可以看到执行了好几次重复的命令</li>
</ol>
<p><code>cmake
   get_filename_component(_IMPORT_PREFIX "${CMAKE_CURRENT_LIST_FILE}" PATH)
   get_filename_component(_IMPORT_PREFIX "${_IMPORT_PREFIX}" PATH)
   get_filename_component(_IMPORT_PREFIX "${_IMPORT_PREFIX}" PATH)
   get_filename_component(_IMPORT_PREFIX "${_IMPORT_PREFIX}" PATH)</code></p>
<p>如果当前文件路径是 <code>/usr/local/lib/cmake/opencv4</code>，那么四次设置 <code>get_filename_component</code> 分别表示</p>
<ul>
<li>得到<code>/usr/local/lib/cmake/opencv4</code></li>
<li>得到<code>/usr/local/lib/cmake</code></li>
<li>得到<code>/usr/local/lib</code></li>
<li>得到<code>/usr/local</code></li>
</ul>
<p>最终的 <code>_IMPORT_PREFIX</code> 正是项目的安装路径 <code>/usr/local</code></p>
<ol>
<li><strong>创建导入目标，并初步设置属性</strong></li>
</ol>
<p>这是该导出配置文件的核心所在，包含了类似如下的一系列语句</p>
<p>```cmake
   # Create imported target opencv_core
   add_library(opencv_core SHARED IMPORTED)</p>
<p># Create imported target opencv_flann
   add_library(opencv_flann SHARED IMPORTED)</p>
<p>set_target_properties(opencv_flann PROPERTIES
     INTERFACE_LINK_LIBRARIES "opencv_core;opencv_core"
   )
   ```</p>
<p>可能有读者会注意到，这里并没有为导入目标设置 <code>IMPORTED_LOCATION</code> 属性。没错，所以说这里是==初步==设置属性。</p>
<ol>
<li>
<p>包含 <code>OpenCVModules-&lt;config&gt;.cmake</code> 文件，在此文件中==进一步==设置属性。如果该项目是</p>
</li>
<li>
<p>Release 模式编译的，那么会包含 <code>OpenCVModules-release.cmake</code> 文件</p>
</li>
<li>Debug 模式编译的，那么会包含 <code>OpenCVModules-debug.cmake</code> 文件</li>
<li>不指定配置模式的，那么会包含 <code>OpenCVModules-noconfig.cmake</code> 文件</li>
</ol>
<p>在 <code>OpenCVModules-&lt;config&gt;.cmake</code> 文件中会为导入目标设置 <code>IMPORTED_LOCATION_&lt;config&gt;</code> 的相关属性，例如</p>
<p>```cmake
   # Import target "opencv_core" for configuration "Release"
   set_property(TARGET opencv_core APPEND PROPERTY IMPORTED_CONFIGURATIONS RELEASE)
   set_target_properties(opencv_core PROPERTIES
     IMPORTED_LOCATION_RELEASE "${_IMPORT_PREFIX}/lib/libopencv_core.so.4.8.0"
     IMPORTED_SONAME_RELEASE "libopencv_core.so.408"
     )</p>
<p>list(APPEND _IMPORT_CHECK_TARGETS opencv_core )
   ```</p>
<p>无论是这里的 <code>IMPORTED_LOCATION_RELEASE</code> 还是自己设置导入目标中的 <code>IMPORTED_LOCATION</code>，都会为目标设置 <code>LOCATION</code> 属性，这正是目标能够被正确链接的关键。</p>
<ol>
<li>检查所有导入目标所指定的库文件（<code>*.a</code> 或者 <code>*.so</code>）是否存在。</li>
</ol>
<p><code>OpenCVModules-&lt;config&gt;.cmake</code> 文件中为所有的导入目标都设置了库文件的路径，这个路径的存在与否将在此进行判断，不存在将会立刻终止 CMake 程序。</p>
<h3 id="34-target_xxx">3.4 回顾：为何要使用 target_xxx</h3>
<p>::: tip
下面介绍一个经常被提及的话题，为什么要使用 <code>target_xxx</code>
:::</p>
<p>在<a href="../05-%E7%9B%AE%E6%A0%87%E6%9E%84%E5%BB%BA/#_2-目标构建">【05】目标构建 #2</a>一文中介绍了 <code>target_include_directories</code> 和 <code>target_link_libraries</code> 的用法，并指出尽量不要使用 <code>include_directories</code> 和 <code>link_libraries</code> 两种，下面将根据本文导出配置的内容介绍为何要使用 <code>target_xxx</code>。</p>
<p>一般使用 <code>target_include_directories</code> 的时候，需要包含的目录会与指定的 CMake 目标绑定起来（这里的目标同样可以是库、可执行文件、接口库等内容），比方说以下命令</p>
<pre><code class="language-cmake">add_library(aa aaa.cpp)
target_include_directories(
  aa PUBLIC
  $&lt;BUILD_INTERFACE:${CMAKE_CURRENT_LIST_DIR}/include&gt;
  $&lt;INSTALL_INTERFACE:include/MyLibrary&gt;
)

####################
###  other code  ###
####################

add_library(bb bbb.cpp)
target_link_libraries(
  bb
  PUBLIC aa
)

</code></pre>
<p>根据以前的知识</p>
<ul>
<li>会把 <code>include</code> 目录添加到 <code>aa</code> 目标下</li>
<li><code>aa</code> 会被 <code>bb</code> 所链接</li>
</ul>
<p>此外，如果 <code>aa</code> 和 <code>bb</code> 目标被安装至导出目标 <code>MyModules</code> 上，并且安装，即使用以下代码</p>
<pre><code class="language-cmake">install(
  TARGETS aa bb
  EXPORT MyModules
)
install(
  EXPORT MyModules
  FILE MyModules.cmake
  DESTINATION &quot;${CMAKE_INSTALL_LIBDIR}/cmake/MyLibrary&quot;
)
</code></pre>
<p>运行 <code>cmake --install .</code> 后可以在安装路径 <code>&lt;path-to-install&gt;/cmake/MyLibrary/MyModules.cmake</code> 下找到如下类似的语句</p>
<pre><code class="language-cmake"># Create imported target aa
add_library(aa STATIC IMPORTED)

set_target_properties(aa PROPERTIES
  INTERFACE_INCLUDE_DIRECTORIES &quot;${_IMPORT_PREFIX}/include/MyLibrary&quot;
)

## Create imported target bb
add_library(bb STATIC IMPORTED)

set_target_properties(bb PROPERTIES
  INTERFACE_LINK_LIBRARIES &quot;aa&quot;
)
</code></pre>
<p>这便是使用 <code>target_xxx</code> 命令的作用，在导出并安装时，会将这些链接、包含关系继续绑定在该目标上，而使用 <code>include_directories</code> 和 <code>link_libraries</code> 则没有这些效果。当然，在不需要进行导出安装的项目中，完全可以使用这些不带 <code>target_</code> 前缀的这些命令。不过这些不带 <code>target_</code> 为前缀的命令会作为全局包含的形式给其他目标使用，有一定的 “污染” 嫌疑。</p>
<h2 id="4-xxxconfigcmake">4. XxxConfig.cmake 文件的一般写法</h2>
<h3 id="41">4.1 写法</h3>
<p>在使用</p>
<pre><code class="language-cmake">find_package(OpenCV REQUIRED)
</code></pre>
<p>的时候，就是按照搜索原则，在系统路径下寻找 <code>OpenCVConfig.cmake</code> 文件，若我们想通过使用 <code>Config</code> 模式，使用</p>
<pre><code class="language-cmake">find_package(MyLibrary REQUIRED)
</code></pre>
<p>来发现包，我们也需要在合适的位置创建 <code>MyLibraryConfig.cmake</code> 文件，这个文件一般是通过使用文件安装（即 <code>install(FILES)</code> 的方式安装到指定位置的）。一个 <code>XxxConfig.cmake</code> 文件与 <code>FindXxx.cmake</code> 包含的内容基本一致，包含</p>
<ol>
<li>搜索头文件</li>
<li>搜索库文件</li>
<li>提供 CMake 目标变量</li>
<li>搜寻的结果、状态</li>
</ol>
<p>这里直接给出内容</p>
<pre><code class="language-cmake"># ======================================================
#  MyLibrary CMake 配置文件
# ======================================================

# ======================================================
#  头文件搜索
# ======================================================
# 获取没有 ../.. 相对路径标记的绝对路径
get_filename_component(ML_CONFIG_PATH &quot;${CMAKE_CURRENT_LIST_DIR}&quot; REALPATH)
get_filename_component(ML_INSTALL_PATH &quot;${ML_CONFIG_PATH}/../../../&quot; REALPATH)

# 搜索，添加至全局变量 MyLibrary_INCLUDE_DIRS
set(ML_INCLUDE_COMPONENTS &quot;${ML_INSTALL_PATH}/include/MyLibrary&quot;)
set(MyLibrary_INCLUDE_DIRS &quot;&quot;)
foreach(d ${ML_INCLUDE_COMPONENTS})
  get_filename_component(_d &quot;${d}&quot; REALPATH)
  if(NOT EXISTS &quot;${_d}&quot;)
    message(WARNING &quot;MyLibrary: Include directory doesn't exist: '${d}'. MyLibrary installation may be broken. Skip...&quot;)
  else()
    list(APPEND MyLibrary_INCLUDE_DIRS &quot;${_d}&quot;)
  endif()
endforeach()
unset(_d)

# ======================================================
# 库文件搜索
# ======================================================
# 包含导出配置的 *.cmake 文件
include(${CMAKE_CURRENT_LIST_DIR}/MyModules.cmake)

# 添加至全局变量 MyLibrary_LIBS
set(ML_LIB_COMPONENTS my_target;my_target_2)
foreach(_mlcomponent ${ML_LIB_COMPONENTS})
  set(MyLibrary_LIBS ${MyLibrary_LIBS} &quot;${_mlcomponent}&quot;)
endforeach()

# ======================================================
# 搜寻的结果、状态
# ======================================================
include(FindPackageHandleStandardArgs)
find_package_handle_standard_args(
  MyLibrary
  REQUIRED_VARS ML_INSTALL_PATH
)
</code></pre>
<p>可以留意到这里的库文件搜索不再像 <code>FindXxx.cmake</code> 那样需要自己指定动态库或静态库的路径，这里是否是动态库或者静态库完全不需要由导出者指定，导出者只需要包含导出配置的文件即可，因为与库目标相关的设置正是由导出配置完成。理论上，如果不需要全局变量 <code>xxx_INLCUDE_DIRS</code> 或者 <code>xxx_LIBS</code> 以及搜寻的状态的话，<code>XxxConfig.cmake</code> 文件可以短到只有几行（注释删掉就是 1 行）：</p>
<pre><code class="language-cmake"># ======================================================
#  MyLibrary CMake 配置文件
# ======================================================

include(${CMAKE_CURRENT_LIST_DIR}/MyModules.cmake)
</code></pre>
<p>因为在 <code>MyLibrary</code> 中，目标只有 <code>my_target</code> 和 <code>my_target_2</code>，并且与其相关的配置全部设置在了导出目标的文件 <code>MyModules.cmake</code> 中。</p>
<h3 id="42-opencvconfigcmake">4.2 剖析 OpenCVConfig.cmake</h3>
<p>以下展示了 OpenCV 4.8.0 的用于 <code>find_package</code> 的 Config 文件，点击<a href="10/OpenCVConfig.cmake.md">此处</a>跳转至该文件。</p>
<p>按照文件中的顺序，主要包含</p>
<ol>
<li>提供注释</li>
</ol>
<p><code>OpenCVConfig.cmake</code> 文件提供了很长的注释内容，用户可以直接对照此注释内容进行使用</p>
<ol>
<li>提供版本信息</li>
</ol>
<p>在此文件的一开头，OpenCV 就设置了版本号信息</p>
<ol>
<li>搜索头文件</li>
</ol>
<p>常规操作，与上文的<font color="green">一般写法</font>基本一致</p>
<ol>
<li>搜索库文件、提供 CMake 目标变量</li>
</ol>
<p>常规操作，同样分为两个部分。第一部分直接包含导出配置文件 <code>OpenCVModules.cmake</code>，用于配置所有的导入目标，第二部分设置 <code>OpenCV_LIBS</code> 变量，用于包含所有的导入目标。</p>
<p>::: warning
   - 与上文一般写法有所不同的是，OpenCV 没有在 <code>OpenCVModules.cmake</code> 中为目标配置包含头文件的搜索路径，因为 OpenCV 在项目中使用的 <code>ocv_target_include_directories</code> 命令使用了 <code>PRIVATE</code> 作为传播属性，那么也就不会在 <code>OpenCVModules.cmake</code> 中有包含头文件路径的配置；</p>
<ul>
<li>
<p>不过在 <code>OpenCVConfig.cmake</code> 中是通过手动 <code>foreach</code> 每个导入目标并进行 <code>set_target_properties</code> 操作，为每个导入目标配置 <code>INTERFACE_INCLUDE_DIRECTORIES</code> 属性的。
   :::</p>
</li>
<li>
<p>搜寻的结果、状态</p>
</li>
</ul>
<p>常规操作，同样是使用 <code>find_package_handle_standard_args</code> 命令获取搜索的结果与状态</p>
<h2 id="5-cmake">5. CMake 项目导出与安装的内容总结</h2>
<p>总的来说需要完成</p>
<ul>
<li>添加常规目标的安装规则，并指定导出目标</li>
<li>添加导出目标的安装规则</li>
<li>编写 <code>XxxConfig.cmake</code> 文件，并添加安装规则</li>
<li>编译项目，执行安装步骤，例如 <code>cmake --install .</code></li>
</ul>
<h2 id="thinking">思考 :thinking:</h2>
<ol>
<li>导入目标和导出目标有什么不同？使用场景是什么？</li>
<li>使用以下命令安装接口库，会有什么效果？
   <code>cmake
   install(
     TARGETS my_interface
     LIBRARY DESTINATION lib
     ARCHIVE DESTINATION lib
     RUNTIME DESTINATION bin
   )</code></li>
</ol>
<p><strong>答案</strong> <a href="10/answer.md">【点此查看】</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright © AI之覔</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../extra.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
